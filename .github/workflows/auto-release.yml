name: Auto Release on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get latest tag
        LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST"
        
        # Calculate next version
        VERSION=${LATEST#v}
        IFS='.' read -ra PARTS <<< "$VERSION"
        MAJOR=${PARTS[0]:-0}
        MINOR=${PARTS[1]:-0}
        PATCH=${PARTS[2]:-0}
        
        # Increment patch version
        NEW_VERSION="v$MAJOR.$MINOR.$((PATCH + 1))"
        echo "New version: $NEW_VERSION"
        
        # Create release with GitHub CLI
        gh release create "$NEW_VERSION" \
          --title "Release $NEW_VERSION" \
          --notes "## What's Changed

        **PR #${{ github.event.number }}**: ${{ github.event.pull_request.title }}

        **Changes in this release:**
        - Merged PR #${{ github.event.number }} by @${{ github.event.pull_request.user.login }}

        **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LATEST}...${NEW_VERSION}" \
          --latest
        
        echo "âœ… Created GitHub release: $NEW_VERSION"
