name: Auto Release on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main, master]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
    - name: Debug PR Event
      run: |
        echo "PR merged: ${{ github.event.pull_request.merged }}"
        echo "PR number: ${{ github.event.number }}"
        echo "Base branch: ${{ github.event.pull_request.base.ref }}"
        echo "Repository: ${{ github.repository }}"
        
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Debug Git Status
      run: |
        echo "Current branch:"
        git branch -a
        echo "Current commit:"
        git log --oneline -5
        echo "Existing tags:"
        git tag -l
        echo "Remote info:"
        git remote -v
        
    - name: Create Release Tag
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e  # Exit on error
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Get latest tag
        LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST"
        
        # Calculate next version
        VERSION=${LATEST#v}
        IFS='.' read -ra PARTS <<< "$VERSION"
        MAJOR=${PARTS[0]:-0}
        MINOR=${PARTS[1]:-0}
        PATCH=${PARTS[2]:-0}
        
        # Increment patch version
        NEW_VERSION="v$MAJOR.$MINOR.$((PATCH + 1))"
        echo "New version: $NEW_VERSION"
        
        # Check if tag already exists
        if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
          echo "Tag $NEW_VERSION already exists!"
          exit 1
        fi
        
        # Create tag
        echo "Creating tag: $NEW_VERSION"
        git tag -a "$NEW_VERSION" -m "Auto release $NEW_VERSION - PR #${{ github.event.number }}: ${{ github.event.pull_request.title }}"
        
        # Push tag
        echo "Pushing tag: $NEW_VERSION"
        git push origin "$NEW_VERSION"
        
        echo "âœ… Successfully created and pushed release tag: $NEW_VERSION"
